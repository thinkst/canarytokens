import{a as E,b as C}from"./awsInfra-BYpPDmKt.js";import{S as r}from"./GenerateLoadingState-lXR4o1cB.js";import{r as h,L as _}from"./index-C8tSFf5z.js";function W(m,y,p){const a=h(""),e=h(),f=h(null),A=h(p||""),I=h(0),g=5e3,n=5;async function O(){await S()}async function S(){var R,o;a.value="",e.value=r.LOADING;let t=0;try{const l=await E({canarytoken:m,auth_token:y,external_id:A.value||""});if(l.status!==200){e.value=r.ERROR,a.value=l.data.message;return}const s=l.data.handle,u=async()=>{var d,v,c,w;try{const i=await E({handle:s});if(i.status===200&&i.data.session_credentials_retrieved){await T();return}if(t>=n){e.value=r.ERROR,a.value=((d=i.data)==null?void 0:d.error)||((v=i.data)==null?void 0:v.message)||"Max retries reached";return}setTimeout(()=>{console.log(`Retrying AWS Infra Role Check (${t}/${n})`),t++,u()},g)}catch(i){if(t>=n){e.value=r.ERROR,a.value=((w=(c=i.response)==null?void 0:c.data)==null?void 0:w.message)||"An error occurred while checking the Role. Try again";return}console.log(`Retrying AWS Infra Role Check (${t}/${n})`),setTimeout(()=>{t++,u()},g)}};await u()}catch(l){e.value=r.ERROR,a.value=((o=(R=l.response)==null?void 0:R.data)==null?void 0:o.message)||"An error occurred while checking the Role. Try again"}}async function T(){var t,R;a.value="",e.value=r.LOADING;try{const o=await C({canarytoken:m,auth_token:y});if(o.status!==200){e.value=r.ERROR,a.value=o.data.error_message;return}const l=o.data.handle;let s=0;const u=async()=>{var d,v;try{const c=await C({handle:l});if(c.data.proposed_plan){e.value=r.SUCCESS,f.value=c.data.proposed_plan,I.value=c.data.data_generation_remaining;return}if(s>=n){e.value=r.ERROR,a.value="Max retries reached";return}setTimeout(()=>{console.log(`Retrying Inventory Customer Account (${s}/${n})`),s++,u()},g)}catch(c){if(s>=n){e.value=r.ERROR,a.value=((v=(d=c.response)==null?void 0:d.data)==null?void 0:v.message)||"An error occurred while inventoring the account. Try again";return}setTimeout(()=>{console.log(`Retrying Inventory Customer Account (${s}/${n})`),s++,u()},g)}};await u()}catch(o){e.value=r.ERROR,a.value=((R=(t=o.response)==null?void 0:t.data)==null?void 0:R.message)||"An error occurred while inventoring the account. Try again"}}return _(()=>p,t=>{A.value=t||""}),{errorMessage:a,stateStatus:e,handleFetchUserAccount:O,proposedPlan:f,availableAiNames:I}}export{W as u};
