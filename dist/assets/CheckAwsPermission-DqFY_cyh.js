const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/ModalSetupRolePolicySnippet-BWUq5C7p.js","assets/index-DatEjxfX.js","assets/index-0vKgOJBC.css","assets/BaseCodeSnippet.vue_vue_type_script_setup_true_lang-BRMUtiF-.js","assets/BaseCopyButton-BKqjxG5T.js","assets/BaseCopyButton-KGQptQmY.css","assets/BaseCodeSnippet-D6zLgBnL.css","assets/BaseLabelArrow.vue_vue_type_style_index_0_lang-BJreSw0P.js","assets/BaseLabel.vue_vue_type_script_setup_true_lang-XW0qcsN8.js","assets/BaseLabelArrow-DxR5m8sm.css","assets/BaseFormTextField.vue_vue_type_style_index_0_lang-17_lGWXO.js","assets/BaseFormTextField-CLDFD6Rz.css","assets/constants-leaU8Fgz.js"])))=>i.map(i=>d[i]);
import{d as se,r as s,K as B,o as ne,aB as oe,aC as re,aD as le,L as ce,aE as ie,e as i,h as F,k as t,M as f,l as n,f as x,w as o,i as r,j as b,v as l,F as ue,C as me,P as de,D as pe,b as _e,c as we,H as ve}from"./index-DatEjxfX.js";import{_ as fe}from"./BaseFormTextField.vue_vue_type_style_index_0_lang-17_lGWXO.js";import{S as u,u as xe,G as Se,_ as ge}from"./GenerateLoadingState-BgpOescO.js";import{_ as he}from"./BaseCodeSnippet.vue_vue_type_script_setup_true_lang-BRMUtiF-.js";import{_ as be}from"./BaseLabelArrow.vue_vue_type_style_index_0_lang-BJreSw0P.js";import{r as ye}from"./awsInfra-GRFw5Phc.js";import{_ as Ce}from"./StepState.vue_vue_type_script_setup_true_lang-PLGHeW80.js";import{u as ke}from"./useFetchUserAccount-BYarpcTl.js";import"./BaseLabel.vue_vue_type_script_setup_true_lang-XW0qcsN8.js";import"./BaseCopyButton-BKqjxG5T.js";const Ae={class:"flex text-center flex-col"},De={class:"infra-token__title-wrapper flex flex-col items-center"},Ee={class:"flex justify-center"},Re={key:0,class:"flex flex-col text-left items-center"},Ie={class:"font-semibold"},Be={class:"text-left max-w-[100%]"},Fe=se({__name:"CheckAwsPermission",props:{initialStepData:{},currentStepData:{}},emits:["updateStep","storeCurrentStepData"],setup(L,{emit:M}){const N=_e(()=>we(()=>import("./ModalSetupRolePolicySnippet-BWUq5C7p.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12]))),y=M,c=L,{token:S,auth_token:g,aws_region:P,aws_account_number:$}=c.initialStepData,m=s(""),A=s(""),d=s(""),w=s(""),C=s(!1),v=s(""),p=s(u.SUCCESS),k=s(""),{isLoading:h,isError:D}=xe(p),{errorMessage:T,stateStatus:q,handleFetchUserAccount:O,proposedPlan:U,availableAiNames:W}=ke(S,g,B(()=>E.external_id));ne(async()=>{G()});async function G(){m.value=$,A.value=P,c.currentStepData.role_name&&c.currentStepData.aws_account&&c.currentStepData.aws_account_number?(d.value=c.currentStepData.role_name,w.value=c.currentStepData.aws_account,m.value=c.currentStepData.aws_account_number):await K()}const V=B(()=>`aws iam get-role --role-name ${d.value} --query 'Role.AssumeRolePolicyDocument.Statement[0].Condition.StringEquals."sts:ExternalId"' --output text`),j=oe().shape({external_id:re().required("The external ID is required")}),{handleSubmit:z,setFieldValue:H,values:E}=le({validationSchema:j,initialValues:{external_id:""}});async function K(){var a;C.value=!0,v.value="";try{const e=await ye(S,g,A.value);if(e.status!==200||!e.data.role_setup_commands){p.value=u.ERROR,v.value=e.data.error_message||"Failed to generate setup commands";return}d.value=e.data.role_setup_commands.role_name,w.value=e.data.role_setup_commands.aws_account,p.value=u.SUCCESS,y("storeCurrentStepData",{token:S,auth_token:g,role_name:d.value,aws_account:w.value,aws_account_number:m.value,is_managing_token:!0})}catch(e){p.value=u.ERROR,v.value=((a=e.data)==null?void 0:a.message)||"Failed to generate setup commands"}finally{C.value=!1}}async function Z(){k.value="",p.value=u.LOADING,await O()}const R=z(async()=>{await Z()});function J(){const{open:a,close:e}=ue({component:N,attrs:{roleName:d.value,externalId:E.external_id,managementAwsAccount:w.value,accountNumber:m.value,closeModal:()=>{e()},onUpdateExternalId:_=>{H("external_id",_)}}});a()}return ce(()=>q.value,a=>{a&&(p.value=a,a===u.SUCCESS?(y("storeCurrentStepData",{token:S,auth_token:g,role_name:d.value,aws_account:w.value,aws_account_number:m.value,proposed_plan:U.value,available_ai_names:W.value,is_managing_token:!0}),y("updateStep")):a===u.ERROR&&(k.value=T.value,ie(()=>{window.scrollTo({top:document.body.scrollHeight,behavior:"smooth"})})))}),(a,e)=>{const _=me,Q=de,X=be,Y=he,I=ge,ee=fe,ae=pe;return i(),F("section",Ae,[t("div",De,[t("h2",null,f(n(h)?"Checking permission...":"Check your AWS permission"),1)]),t("div",Ee,[n(h)?(i(),x(Ce,{key:0,class:"mb-24 sm:w-[100%] md:max-w-[60vw] lg:max-w-[50vw]","is-loading":n(h)},{loading:o(()=>[r(Se,{instructions:["AWS account found","Verifying permissions","Analysing cloud account"],"img-src":"aws_infra_token_loading_scanner.webp"})]),_:1},8,["is-loading"])):b("",!0)]),n(h)?b("",!0):(i(),F("div",Re,[r(_,{class:"mb-24 sm:w-[100%] md:max-w-[60vw] lg:max-w-[50vw]",variant:"warning"},{default:o(()=>[e[1]||(e[1]=l("In order to proceed we need you to confirm the ")),e[2]||(e[2]=t("span",{class:"font-semibold"},"External ID",-1)),e[3]||(e[3]=l(" for our role on your AWS Account ")),t("span",Ie,f(m.value),1),e[4]||(e[4]=l(". "))]),_:1}),t("div",Be,[C.value?(i(),x(Q,{key:0,class:"w-[100%] h-[300px] mb-24",type:"text"})):(i(),x(I,{key:1,class:"p-40 flex items-center flex-col text-left sm:max-w-[100%] md:max-w-[60vw] lg:max-w-[50vw] place-self-center"},{default:o(()=>[v.value?(i(),x(_,{key:0,class:"mb-24 sm:w-[100%] md:max-w-[60vw] lg:max-w-[50vw]",variant:"danger"},{default:o(()=>[l(f(v.value),1)]),_:1})):b("",!0),e[5]||(e[5]=t("div",{class:"text-center mb-24"},[t("h2",{class:"text-2xl mb-16"},[l(" Run the AWS CLI command below to "),t("span",{class:"font-semibold"},"find the External ID")])],-1)),r(X,{id:"aws-snippet-code",label:"Copy AWS CLI snippet","arrow-word-position":"last","arrow-variant":"two",class:"z-10 text-right"}),r(Y,{id:"aws-snippet-code",lang:"bash",code:V.value,"custom-height":"100px",class:"wrap-code lg:max-w-[50vw]","check-scroll":!0},null,8,["code"])]),_:1})),r(_,{class:"mb-24 mt-24 sm:w-[100%] md:max-w-[60vw] lg:max-w-[50vw]",variant:"info","text-link":"Restore Permissions",onClick:J},{default:o(()=>e[6]||(e[6]=[l("Canarytoken IAM role and policy needed. Did you remove them? ")])),_:1}),r(I,{class:"p-40 text-left place-self-center w-full mt-24 sm:max-w-[100%] md:max-w-[60vw] lg:max-w-[50vw]"},{default:o(()=>[t("form",{class:"flex flex-col gap-16 items-center",onSubmit:e[0]||(e[0]=(...te)=>n(R)&&n(R)(...te))},[r(ee,{id:"external_id",name:"external_id",label:"Add here your External ID",placeholder:"e.g. abCd7Lb6cEZrMCEm3OAoj",required:"","has-arrow":!0,"arrow-variant":"one","arrow-word-position":2,class:"flex-grow external-id-input"}),n(D)?(i(),x(_,{key:0,class:"mb-24 sm:w-[100%] md:max-w-[60vw] lg:max-w-[50vw]",variant:"danger"},{default:o(()=>[l(f(k.value),1)]),_:1})):b("",!0),r(ae,{type:"submit",variant:"primary",class:"self-center"},{default:o(()=>[l(f(n(D)?"Try Again":"Check permissions"),1)]),_:1})],32)]),_:1})])]))])}}}),Ge=ve(Fe,[["__scopeId","data-v-6307914a"]]);export{Ge as default};
