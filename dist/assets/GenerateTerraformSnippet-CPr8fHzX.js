const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/ModalInfoTerraformSnippet-CfMW7_oA.js","assets/index-DiWV8uCK.js","assets/index-CUHUoo6I.css","assets/BaseBulletListItem-CeNy_yx_.js","assets/BaseBulletListItem-CohxRw82.css","assets/ModalInfoTerraformSnippet-Dx021CiJ.css","assets/ModalInfoCleanup-Dk8zKnqU.js","assets/BaseCodeSnippet.vue_vue_type_script_setup_true_lang-CNNNw6Ol.js","assets/BaseCopyButton-CjcrPb58.js","assets/BaseCopyButton-KGQptQmY.css","assets/BaseCodeSnippet-D6zLgBnL.css"])))=>i.map(i=>d[i]);
import{d as oe,a as re,r as T,o as ne,K as se,L as ie,aN as le,T as ce,I as me,ad as ue,e as n,h as f,k as t,M as de,l as a,f as _,w as u,i as g,j as y,v as o,m as pe,ab as B,F as N,C as fe,aE as _e,D as ge,b as P,c as G,H as ve}from"./index-DiWV8uCK.js";import{S as d,u as he,G as we,_ as ye}from"./GenerateLoadingState-BNECSY7E.js";import{_ as xe}from"./BaseCodeSnippet.vue_vue_type_script_setup_true_lang-CNNNw6Ol.js";import{e as V}from"./awsInfra-BRUGaSqc.js";import{_ as Se}from"./StepState.vue_vue_type_script_setup_true_lang-CZ8g5sCK.js";import"./BaseCopyButton-CjcrPb58.js";const Te={class:"section-terraform-snippet flex flex-col items-center"},ke={class:"infra-token__title-wrapper text-center"},Re={key:1,class:"flex flex-col items-center"},be={class:"text-left max-w-[100%]"},Ce={class:"text-center mb-16 flex flex-col items-center"},Ee=["src"],Ie={key:0,class:"textmd mb-16"},Ae={key:1,class:"textmd mb-16"},Me={class:"flex flex-col gap-16 mt-32"},$e={class:"flex flex-row justify-start xl:justify-center gap-16"},Le={class:"flex flex-row justify-center gap-16 items-center"},Oe={class:"flex flex-row mt-40 gap-16"},De=oe({__name:"GenerateTerraformSnippet",props:{initialStepData:{}},emits:["updateStep","storeCurrentStepData"],setup(q,{emit:H}){const X=P(()=>G(()=>import("./ModalInfoTerraformSnippet-CfMW7_oA.js"),__vite__mapDeps([0,1,2,3,4,5]))),j=P(()=>G(()=>import("./ModalInfoCleanup-Dk8zKnqU.js"),__vite__mapDeps([6,1,2,7,8,9,10]))),W=H,Y=q,A=re(),c=T(d.LOADING),{isLoading:v,isError:h,isSuccess:M}=he(c),p=T(""),k=T(""),R=T(""),{token:b,auth_token:C,is_managing_token:F}=Y.initialStepData;ne(async()=>{await L(),window.scrollTo({top:0,behavior:"smooth"})});const $=se(()=>F);async function L(){var x,S;let i=0;p.value="",c.value=d.LOADING;try{const l=await V({canarytoken:b,auth_token:C});l.status!==200&&(c.value=d.ERROR,p.value=l.data.message);const E=l.data.handle,m=async()=>{var w,I,O,D;try{const s=await V({handle:E});if(s.status===200&&s.data.terraform_module_snippet){c.value=d.SUCCESS;const Z=s.data.terraform_module_snippet.source,ee=s.data.terraform_module_snippet.module;k.value=z(Z,ee);const te=s.data.role_cleanup_commands.role_name,ae=s.data.role_cleanup_commands.customer_aws_account;R.value=J(te,ae),W("storeCurrentStepData",{token:b,auth_token:C,terraformSnippet:k.value,cleaupSnippet:R.value});return}if(i>=5){c.value=d.ERROR,p.value=((w=s.data)==null?void 0:w.message)||((I=s.data)==null?void 0:I.error)||"Max retries reached";return}setTimeout(()=>{console.log(`Retrying requesting the Terraform Snippet (${i}/5)`),i++,m()},2e3)}catch(s){if(i>=5){c.value=d.ERROR,p.value=((D=(O=s.response)==null?void 0:O.data)==null?void 0:D.message)||"An error occurred while generating your Terraform Snippet. Try again";return}setTimeout(()=>{console.log(`Retrying requesting the Terraform Snippet (${i}/5)`),i++,m()},2e3)}};await m()}catch(l){c.value=d.ERROR,p.value=((S=(x=l.response)==null?void 0:x.data)==null?void 0:S.message)||l.message||"An error occurred while generating your Terraform Snippet. Try again"}}function K(){A.push({name:"manage",params:{auth:C,token:b}})}function U(){const{open:r,close:e}=N({component:X,attrs:{closeModal:()=>e()}});r()}function z(r,e){return`module "${e}" {
    source = "${r}"
  }
`}function J(r,e){return`aws iam detach-role-policy --role-name ${r} --policy-arn arn:aws:iam::${e}:policy/Canarytokens-Inventory-ReadOnly-Policy

aws iam delete-policy --policy-arn arn:aws:iam::${e}:policy/Canarytokens-Inventory-ReadOnly-Policy

aws iam delete-role --role-name  ${r}`}function Q(){const{open:r,close:e}=N({component:j,attrs:{closeModal:()=>e(),cleanupSnippetCommands:R.value}});r()}return ie(M,r=>{r===!0&&le(ce.AWS_INFRA,".section-terraform-snippet")}),(r,e)=>{const i=fe,x=_e,S=xe,l=me("font-awesome-icon"),E=ye,m=ge,w=ue("tooltip");return n(),f("section",Te,[t("div",ke,[t("h2",null,de(a(v)?"Preparing the Terraform module...":"Deploy your decoys"),1)]),a(v)||a(h)?(n(),_(Se,{key:0,"is-loading":a(v),"is-error":a(h),"error-message":p.value},{loading:u(()=>[g(we,{instructions:["Preparing Decoys","Generating infrastructure","Generating module"],"img-src":"aws_infra_token_loading_folder.webp"})]),_:1},8,["is-loading","is-error","error-message"])):y("",!0),a(M)?(n(),f("div",Re,[t("div",be,[t("div",null,[$.value?(n(),_(i,{key:1,class:"mb-24 sm:w-[100%] md:max-w-[60vw] lg:max-w-[50vw] xl:max-w-[40vw]",variant:"success"},{default:u(()=>e[2]||(e[2]=[o("Your decoy infrastructure design has been updated. All that remains is to re-initialise the Terraform module and deploy it. ")])),_:1})):(n(),_(i,{key:0,class:"mb-24 sm:w-[100%] md:max-w-[60vw] lg:max-w-[50vw] xl:max-w-[40vw]",variant:"success"},{default:u(()=>e[1]||(e[1]=[o("Your decoy infrastructure design has been generated and stored. All that remains is to include it into your Terraform configuration, and apply it.")])),_:1}))]),g(E,{class:"p-40 flex items-center flex-col text-left sm:max-w-[100%] md:max-w-[60vw] lg:max-w-[50vw] xl:max-w-[40vw] place-self-center"},{default:u(()=>[t("div",Ce,[t("img",{src:a(pe)("terraform_icon.svg"),alt:"terraform-icon",class:"w-[2.5rem] h-[2.5rem] mb-8"},null,8,Ee),$.value?(n(),f("h2",Ae,e[4]||(e[4]=[o(" Your Terraform should already include this snippet, but you will need to re-run "),t("span",{class:"monospace"},"$ terraform init --upgrade",-1),o(" to update the module, and "),t("span",{class:"monospace"},"$ terraform apply",-1),o(" to make the changes. ")]))):(n(),f("h2",Ie,e[3]||(e[3]=[o(" Add this snippet to your Terraform configuration file then run "),t("span",{class:"monospace"},"$ terraform init",-1),o(" to import the module, and "),t("span",{class:"monospace"},"$ terraform apply ",-1),o(" to create the resources. ")])))]),g(x,{id:"terraform-module",label:"Copy Terraform snippet","arrow-word-position":"last","arrow-variant":"one",class:"z-10 text-right"}),g(S,{id:"terraform-module",lang:"bash",code:k.value,class:"w-full wrap-code","custom-height":"100px"},null,8,["code"]),t("div",Me,[t("div",$e,[e[5]||(e[5]=t("p",null,"How do I use this module?",-1)),B((n(),f("button",{class:"w-24 h-24 text-sm duration-150 bg-transparent border border-solid rounded-full hover:text-white hover:bg-green-600 hover:border-green-300 shrink-0","aria-label":"What's this snippet doing?",onClick:U},[g(l,{icon:"question","aria-hidden":"true"})])),[[w,{content:"Check details",triggers:["hover"]}]])]),t("div",Le,[e[6]||(e[6]=t("p",{class:"text-wrap lg:text-nowrap"}," How do I clean up IAM resources for Canarytokens Inventory? ",-1)),B((n(),f("button",{class:"w-24 h-24 text-sm duration-150 bg-transparent border border-solid rounded-full hover:text-white hover:bg-green-600 hover:border-green-300 shrink-0","aria-label":"How do I cleanup my AWS accont?",onClick:Q},[g(l,{icon:"question","aria-hidden":"true"})])),[[w,{content:"Check details",triggers:["hover"]}]])])])]),_:1})]),e[7]||(e[7]=t("h2",{class:"text-md mt-24 text-center"},[o(" That’s it! Once you’ve applied the Terraform configuration "),t("br"),o("and created the decoy resources, any interactions with them will give you an alert. ")],-1))])):y("",!0),a(h)?(n(),_(m,{key:2,class:"mt-40",variant:"secondary",onClick:L},{default:u(()=>e[8]||(e[8]=[o(" Try again ")])),_:1})):y("",!0),t("div",Oe,[!a(v)&&!a(h)?(n(),_(m,{key:0,variant:"secondary",onClick:e[0]||(e[0]=I=>a(A).push("/"))},{default:u(()=>e[9]||(e[9]=[o(" Back Home")])),_:1})):y("",!0),!a(v)&&!a(h)?(n(),_(m,{key:1,variant:"secondary",onClick:K},{default:u(()=>e[10]||(e[10]=[o(" Manage Token")])),_:1})):y("",!0)])])}}}),He=ve(De,[["__scopeId","data-v-e8c9f9c9"]]);export{He as default};
