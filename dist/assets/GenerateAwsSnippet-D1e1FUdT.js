const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/ModalInfoSnippet-sx2NbL3O.js","assets/index-DatEjxfX.js","assets/index-0vKgOJBC.css","assets/BaseBulletList.vue_vue_type_script_setup_true_lang-4lHFxCLE.js","assets/BaseBulletListItem-BfV7BfUK.js","assets/BaseBulletListItem-CohxRw82.css","assets/ModalEditAWSInfo-sVi0cv75.js","assets/BaseFormSelect.vue_vue_type_style_index_0_lang-BdeIvx6p.js","assets/BaseFormSelect-CntJSWeK.css","assets/BaseFormTextField.vue_vue_type_style_index_0_lang-17_lGWXO.js","assets/BaseLabelArrow.vue_vue_type_style_index_0_lang-BJreSw0P.js","assets/BaseLabel.vue_vue_type_script_setup_true_lang-XW0qcsN8.js","assets/BaseLabelArrow-DxR5m8sm.css","assets/BaseFormTextField-CLDFD6Rz.css","assets/constants-leaU8Fgz.js","assets/awsInfra-GRFw5Phc.js"])))=>i.map(i=>d[i]);
import{d as ce,r as l,K as F,o as ue,L as pe,I as de,ad as me,e as s,h as x,k as o,M as W,f as v,l as p,j as u,w as d,i as _,z as ve,v as r,ab as _e,q as fe,F as V,C as we,D as ge,b as U,c as q,H as Se}from"./index-DatEjxfX.js";import{S as i,u as ye,G as xe,_ as he}from"./GenerateLoadingState-BgpOescO.js";import{_ as Ce}from"./BaseCodeSnippet.vue_vue_type_script_setup_true_lang-BRMUtiF-.js";import{_ as ke}from"./BaseLabelArrow.vue_vue_type_style_index_0_lang-BJreSw0P.js";import{r as be}from"./awsInfra-GRFw5Phc.js";import{_ as z}from"./StepState.vue_vue_type_script_setup_true_lang-PLGHeW80.js";import{u as Ae}from"./useFetchUserAccount-BYarpcTl.js";import{p as Re}from"./constants-leaU8Fgz.js";import"./BaseCopyButton-BKqjxG5T.js";import"./BaseLabel.vue_vue_type_script_setup_true_lang-XW0qcsN8.js";const De={class:"flex text-center flex-col"},Ie={class:"infra-token__title-wrapper flex flex-col items-center"},Ee={class:"flex justify-center"},Me={key:0,class:"flex flex-col items-center"},We={class:"text-left max-w-[100%]"},Oe={class:"text-center mb-24"},Pe={class:"flex justify-center mb-24"},Be={class:"monospace"},Ge={class:"text-center flex mt-24 gap-8 items-center justify-center"},Le={class:"mt-24 flex flex-col items-center"},Ne={class:"font-bold"},Te={key:0,class:"flex flex-col items-center"},$e={class:"flex justify-center"},je={key:1},Fe=ce({__name:"GenerateAwsSnippet",props:{initialStepData:{},currentStepData:{}},emits:["updateStep","storeCurrentStepData","storePreviousStepData"],setup(H,{emit:K}){const J=U(()=>q(()=>import("./ModalInfoSnippet-sx2NbL3O.js"),__vite__mapDeps([0,1,2,3,4,5]))),Q=U(()=>q(()=>import("./ModalEditAWSInfo-sVi0cv75.js"),__vite__mapDeps([6,1,2,7,8,9,10,11,12,13,14,15]))),w=K,R=H,{token:g,auth_token:S,aws_region:O,aws_account_number:X}=R.initialStepData,c=l(i.LOADING),m=l(""),h=l(!1),{isLoading:f,isError:C}=ye(c),{errorMessage:Y,stateStatus:Z,handleFetchUserAccount:P,proposedPlan:ee,availableAiNames:te}=Ae(g,S),D=F(()=>c.value!==i.LOADING&&c.value!==i.ERROR),ae=F(()=>f.value&&!a.value?"Generating AWS Snippet":f.value&&a.value?"Analysing your AWS account":"Setup AWS role and policy"),a=l(""),k=l(""),B=l(""),G=l(0),b=l(""),I=l(""),E=l(!1),y=l(!1);ue(async()=>{k.value=X,B.value=O;const t=R.currentStepData.code_snippet_command;t?(a.value=t,c.value=i.SUCCESS):await L()});async function L(){var t,e;c.value=i.LOADING,m.value="";try{const n=await be(g,S,O);n.status!==200&&(c.value=i.ERROR,n.data.error_message=m),f.value=!1,n.data.role_setup_commands||(c.value=i.ERROR,m.value="Something went wrong when we tried to generate your snippet. Please try again."),G.value=n.data.role_setup_commands.aws_account,I.value=n.data.role_setup_commands.external_id,b.value=n.data.role_setup_commands.role_name;const M=$();a.value=M,c.value=i.SUCCESS,w("storeCurrentStepData",{token:g,auth_token:S,code_snippet_command:a.value})}catch(n){c.value=i.ERROR,m.value=((e=(t=n.response)==null?void 0:t.data)==null?void 0:e.message)||n}}function oe(t){w("storePreviousStepData",t),k.value=t.aws_account_number,B.value=t.aws_region,a.value=$(),w("storeCurrentStepData",{token:g,auth_token:S,code_snippet_command:a.value})}function N(){E.value=!0}async function T(){E.value?(y.value=!1,h.value=!0,setTimeout(async()=>{h.value=!1,await P()},3500)):(y.value=!0,E.value=!0)}function ne(){const{open:t,close:e}=V({component:Q,attrs:{closeModal:()=>e(),saveData:n=>oe(n),tokenData:R.initialStepData}});t()}pe(()=>Z.value,t=>{t&&(c.value=t,t===i.SUCCESS?(w("storeCurrentStepData",{token:g,auth_token:S,code_snippet_command:a.value,proposed_plan:ee.value,available_ai_names:te.value}),w("updateStep")):t===i.ERROR&&(m.value=Y.value,window.scrollTo({top:0,behavior:"smooth"})))});function se(){const{open:t,close:e}=V({component:J,attrs:{closeModal:()=>e()}});t()}function $(){return`aws iam create-role --no-cli-pager --role-name ${b.value} --assume-role-policy-document '{"Version": "2012-10-17", "Statement": [{"Effect": "Allow", "Principal": {"AWS": "arn:aws:sts::${G.value}:assumed-role/InventoryManagerRole/${I.value}"}, "Action": "sts:AssumeRole", "Condition": {"StringEquals": {"sts:ExternalId": "${I.value}"}}}]}'

aws iam create-policy --no-cli-pager --policy-name Canarytokens-Inventory-ReadOnly-Policy --policy-document '${Re}'

aws iam attach-role-policy --role-name ${b.value} --policy-arn arn:aws:iam::${k.value}:policy/Canarytokens-Inventory-ReadOnly-Policy
`}return(t,e)=>{const n=ke,M=Ce,le=de("font-awesome-icon"),re=he,j=we,A=ge,ie=me("tooltip");return s(),x("section",De,[o("div",Ie,[o("h2",null,W(ae.value),1)]),o("div",Ee,[!D.value&&!a.value?(s(),v(z,{key:0,"is-loading":p(f),"is-error":p(C),"loading-message":"We are generating the snippet. Hold on…","error-message":m.value},null,8,["is-loading","is-error","error-message"])):u("",!0),!D.value&&a.value?(s(),v(z,{key:1,class:"mb-24 max-w-[100%] md:max-w-[70vw] lg:max-w-[50vw] xl:max-w-[50vw]","is-loading":p(f),"is-error":p(C),"error-message":m.value},{loading:d(()=>[_(xe,{instructions:["AWS account found","Verifying setup","Analysing cloud account"],"img-src":"aws_infra_token_loading_scanner.webp"})]),_:1},8,["is-loading","is-error","error-message"])):u("",!0)]),!p(f)&&a.value?(s(),x("div",Me,[o("div",We,[_(re,{class:"p-40 pt-24 flex items-center flex-col text-left max-w-[100%] md:max-w-[60vw] lg:max-w-[40vw] xl:max-w-[40vw] place-self-center"},{default:d(()=>[o("div",Oe,[o("div",Pe,[_(ve,{title:"aws infra token","logo-img-url":"aws_infra.png","has-shadow":!0,class:"w-[5rem]"})]),o("p",null,[e[0]||(e[0]=r(" Execute the AWS CLI snippet below. These commands create a read-only IAM role ( ")),o("span",Be,W(b.value),1),e[1]||(e[1]=r(" ) and policy ( ")),e[2]||(e[2]=o("span",{class:"monospace"},"Canarytokens-Inventory-ReadOnly-Policy",-1)),e[3]||(e[3]=r(" ). "))])]),_(n,{id:"aws-snippet",label:"Copy AWS CLI snippet","arrow-word-position":"last","arrow-variant":"two",class:"z-10 text-right"}),a.value?(s(),v(M,{key:0,id:"aws-snippet",lang:"bash",code:a.value,"custom-height":"120px",class:"wrap-code max-w-[100%]","check-scroll":!0,onCopyContent:N,onSnippetScrolled:N},null,8,["code"])):u("",!0),o("div",Ge,[e[4]||(e[4]=o("p",null,"What's this snippet doing?",-1)),_e((s(),x("button",{class:"w-24 h-24 text-sm duration-150 bg-transparent border border-solid rounded-full hover:text-white hover:bg-green-600 hover:border-green-300","aria-label":"What's this snippet doing?",onClick:se},[_(le,{icon:"question","aria-hidden":"true"})])),[[ie,{content:"Check details",triggers:["hover"]}]])])]),_:1}),o("div",Le,[_(j,{class:"mb-24 max-w-[100%] md:max-w-[60vw] lg:max-w-[40vw] xl:max-w-[40vw] md:text-justify text-pretty",variant:"info"},{default:d(()=>[e[5]||(e[5]=r("Please ensure you have run the above commands on the ")),o("span",Ne,W(k.value),1),e[6]||(e[6]=r(" AWS account ")),o("button",{class:"font-semibold",onClick:fe(ne,["stop"])}," (edit) "),e[7]||(e[7]=r(" before continuing, otherwise the setup won’t work. "))]),_:1})]),D.value?(s(),x("div",Te,[y.value?(s(),v(j,{key:0,variant:"warning",class:"mb-24 max-w-[100%] md:max-w-[60vw] lg:max-w-[40vw] xl:max-w-[40vw] text-justify"},{default:d(()=>e[8]||(e[8]=[r(" Make sure to run the command above. Otherwise, we won't be able to generate your Canarytoken. ")])),_:1})):u("",!0),y.value?u("",!0):(s(),v(A,{key:1,loading:h.value,onClick:T},{default:d(()=>e[9]||(e[9]=[r(" Continue ")])),_:1},8,["loading"])),y.value?(s(),v(A,{key:2,loading:h.value,onClick:T},{default:d(()=>e[10]||(e[10]=[r(" I Ran the Command, Continue ")])),_:1},8,["loading"])):u("",!0)])):u("",!0)])])):u("",!0),o("div",$e,[p(C)&&!a.value?(s(),v(A,{key:0,variant:"secondary",onClick:L},{default:d(()=>e[11]||(e[11]=[r(" Try again ")])),_:1})):u("",!0),p(C)&&a.value?(s(),x("div",je,[_(A,{variant:"secondary",onClick:p(P)},{default:d(()=>e[12]||(e[12]=[r(" Try again ")])),_:1},8,["onClick"])])):u("",!0)])])}}}),Ze=Se(Fe,[["__scopeId","data-v-53d50b1f"]]);export{Ze as default};
